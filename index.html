
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronos AI 數位觀課儀表板</title>
    <!-- 工具函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- React 18 UMD -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', -apple-system, sans-serif;
            background-color: #020617;
            color: #f8fafc;
            margin: 0;
            overflow: hidden;
        }
        .glass {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(245, 158, 11, 0.1);
        }
        .klimt-gradient {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #7f1d1d 100%);
        }
        .animate-rotate-slow {
            animation: rotate 10s linear infinite;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- 常數定義 (替代 Enum) ---
        const TeachingMode = {
            LECTURE: '講述教學',
            GROUP_DISCUSSION: '小組討論',
            PRACTICE: '實作/演算',
            DIGITAL_USE: '數位運用'
        };

        const TeachingAction = {
            POSITIVE: '正向鼓勵',
            REGULATION: '糾正規範',
            OPEN_Q: '開放提問',
            CLOSED_Q: '封閉提問',
            PATROL: '巡視走動'
        };

        const EngagementLevel = {
            HIGH: '高',
            MEDIUM: '中',
            LOW: '低'
        };

        const SUBJECTS = ['國文', '英文', '數學', '理化', '社會', '體育', '藝術', '資訊'];

        // --- 圖標元件 ---
        const StartButtonIcon = () => (
            <div className="relative w-16 h-16 flex items-center justify-center cursor-pointer">
                <svg className="absolute inset-0 w-full h-full animate-rotate-slow opacity-60" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#f59e0b" strokeWidth="1" strokeDasharray="4 8" />
                </svg>
                <svg className="w-8 h-8 drop-shadow-[0_0_8px_rgba(245,158,11,0.5)] translate-x-1" viewBox="0 0 100 100">
                    <path d="M20,10 L90,50 L20,90 Z" fill="#f59e0b" />
                </svg>
            </div>
        );

        const StopButtonIcon = () => (
            <div className="relative w-16 h-16 flex items-center justify-center cursor-pointer">
                <div className="absolute inset-0 border border-rose-900/30 rotate-45 scale-90"></div>
                <div className="w-8 h-8 bg-gradient-to-br from-rose-600 to-rose-900 rounded-sm shadow-[0_0_10px_rgba(225,29,72,0.4)]"></div>
            </div>
        );

        // --- Gemini 服務 ---
        const getGenAI = async () => {
            const { GoogleGenAI } = await import("https://esm.sh/@google/genai@^1.34.0");
            const apiKey = window.process?.env?.API_KEY || '';
            return new GoogleGenAI({ apiKey });
        };

        // --- 主程式 ---
        const App = () => {
            const [isRunning, setIsRunning] = useState(false);
            const [sessionTime, setSessionTime] = useState(0);
            const [subject, setSubject] = useState(SUBJECTS[0]);
            const [activeMode, setActiveMode] = useState(null);
            const [modeTimers, setModeTimers] = useState({});
            const [actionCounts, setActionCounts] = useState({});
            const [logs, setLogs] = useState([]);
            const [engagement, setEngagement] = useState(EngagementLevel.MEDIUM);
            const [engagementHistory, setEngagementHistory] = useState([]);
            const [showSummary, setShowSummary] = useState(false);
            const [currentNote, setCurrentNote] = useState('');
            const [isPolishing, setIsPolishing] = useState(false);
            const [aiReport, setAiReport] = useState(null);
            const [systemTime, setSystemTime] = useState('');

            const timerRef = useRef(null);

            useEffect(() => {
                const clock = setInterval(() => setSystemTime(new Date().toLocaleTimeString('zh-TW', { hour12: false })), 1000);
                return () => clearInterval(clock);
            }, []);

            useEffect(() => {
                if (isRunning) {
                    timerRef.current = setInterval(() => {
                        setSessionTime(prev => prev + 1);
                        if (activeMode) {
                            setModeTimers(prev => ({
                                ...prev,
                                [activeMode]: (prev[activeMode] || 0) + 1
                            }));
                        }
                    }, 1000);
                } else {
                    clearInterval(timerRef.current);
                }
                return () => clearInterval(timerRef.current);
            }, [isRunning, activeMode]);

            const addLog = (type, label, value = '') => {
                const newLog = {
                    timestamp: new Date().toLocaleTimeString('zh-TW', { hour12: false }),
                    type, label, value
                };
                setLogs(prev => [newLog, ...prev]);
            };

            const formatTime = (s) => {
                const m = Math.floor(s / 60);
                const ss = s % 60;
                return `${m.toString().padStart(2, '0')}:${ss.toString().padStart(2, '0')}`;
            };

            const handlePolish = async () => {
                if (!currentNote.trim()) return;
                setIsPolishing(true);
                try {
                    const ai = await getGenAI();
                    const prompt = `你是一位教學顧問，請將筆記改寫為教育專業用語：\n"${currentNote}"`;
                    const res = await ai.models.generateContent({ model: 'gemini-3-flash-preview', contents: prompt });
                    setCurrentNote(res.text.trim());
                } catch (e) { alert("AI 潤飾失敗，請檢查 API Key"); }
                finally { setIsPolishing(false); }
            };

            const generateAIReport = async () => {
                setIsPolishing(true);
                try {
                    const ai = await getGenAI();
                    const data = { subject, sessionTime, modeTimers, actionCounts, logs };
                    const prompt = `根據以下觀課紀錄生成 Markdown 報告：\n${JSON.stringify(data)}`;
                    const res = await ai.models.generateContent({ model: 'gemini-3-pro-preview', contents: prompt });
                    setAiReport(res.text);
                } catch (e) { alert("生成失敗"); }
                finally { setIsPolishing(false); }
            };

            return (
                <div className="flex flex-col h-screen max-w-7xl mx-auto overflow-hidden bg-slate-950">
                    {/* Header */}
                    <header className="glass px-6 py-4 flex items-center justify-between border-b border-amber-500/10">
                        <div className="flex items-center gap-6">
                            <h1 className="text-2xl font-bold klimt-gradient bg-clip-text text-transparent">Chronos AI</h1>
                            <select 
                                value={subject} 
                                onChange={e => setSubject(e.target.value)}
                                disabled={isRunning}
                                className="bg-slate-900 border border-slate-700 rounded-lg px-3 py-1.5 text-sm text-slate-200 outline-none"
                            >
                                {SUBJECTS.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                            <span className="text-amber-500 font-mono text-xl tracking-widest hidden sm:block">{systemTime}</span>
                        </div>
                        <div onClick={() => {
                            if (!isRunning) {
                                setIsRunning(true); setLogs([]); setModeTimers({}); setActionCounts({}); setSessionTime(0);
                                addLog('ACTION', '觀課開始', subject);
                            } else {
                                setIsRunning(false); addLog('ACTION', '觀課結束'); setShowSummary(true);
                            }
                        }} className="cursor-pointer scale-90">
                            {isRunning ? <StopButtonIcon /> : <StartButtonIcon />}
                        </div>
                    </header>

                    {/* Dashboard */}
                    <main className="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6 p-6 overflow-hidden">
                        {/* Modes */}
                        <div className="lg:col-span-4 flex flex-col gap-4">
                            <h2 className="text-xs font-bold text-slate-500 uppercase tracking-widest">教學模式</h2>
                            <div className="grid grid-cols-2 gap-4">
                                {Object.values(TeachingMode).map(mode => (
                                    <button 
                                        key={mode}
                                        onClick={() => {
                                            if (!isRunning) return;
                                            const isNowActive = activeMode !== mode;
                                            setActiveMode(isNowActive ? mode : null);
                                            addLog('MODE', isNowActive ? '切換至' : '停止', mode);
                                        }}
                                        className={`p-4 rounded-2xl border-2 transition-all flex flex-col items-center justify-center gap-2 ${activeMode === mode ? 'border-amber-500 bg-amber-500/10' : 'border-slate-800 bg-slate-900'}`}
                                    >
                                        <span className={`font-bold ${activeMode === mode ? 'text-amber-400' : 'text-slate-400'}`}>{mode}</span>
                                        <span className="text-xs font-mono text-slate-500">{formatTime(modeTimers[mode] || 0)}</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Actions */}
                        <div className="lg:col-span-4 flex flex-col gap-4">
                            <h2 className="text-xs font-bold text-slate-500 uppercase tracking-widest">行為記錄</h2>
                            <div className="flex flex-col gap-3 overflow-y-auto custom-scrollbar pr-2">
                                {Object.values(TeachingAction).map(action => (
                                    <button 
                                        key={action}
                                        onClick={() => {
                                            if (!isRunning) return;
                                            setActionCounts(prev => ({ ...prev, [action]: (prev[action] || 0) + 1 }));
                                            addLog('ACTION', action);
                                        }}
                                        className="p-4 bg-slate-900 border border-slate-800 rounded-xl flex justify-between items-center hover:border-amber-500/50"
                                    >
                                        <span className="text-slate-300 font-medium">{action}</span>
                                        <span className="bg-slate-950 text-amber-500 px-3 py-1 rounded-lg font-bold">{actionCounts[action] || 0}</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Log Stream */}
                        <div className="lg:col-span-4 flex flex-col gap-4">
                            <h2 className="text-xs font-bold text-slate-500 uppercase tracking-widest">即時紀錄流</h2>
                            <div className="flex-1 bg-slate-900/50 rounded-2xl border border-slate-800 p-4 overflow-y-auto custom-scrollbar flex flex-col gap-3">
                                {logs.map((log, i) => (
                                    <div key={i} className="flex gap-4 border-l-2 border-amber-900/30 pl-4 py-1">
                                        <span className="text-[10px] font-mono text-amber-600 shrink-0 mt-1">{log.timestamp}</span>
                                        <div>
                                            <div className="text-sm font-bold text-slate-300">{log.label}</div>
                                            {log.value && <div className="text-xs text-slate-500">{log.value}</div>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>

                    {/* Footer */}
                    <footer className="glass p-6 flex flex-col md:flex-row gap-6 items-center">
                        <div className="flex gap-2 w-full md:w-auto">
                            {Object.values(EngagementLevel).map(l => (
                                <button 
                                    key={l}
                                    onClick={() => { setEngagement(l); addLog('ENGAGEMENT', '專注度更新', l); }}
                                    className={`flex-1 px-4 py-2 rounded-xl font-bold border-2 transition-all ${engagement === l ? 'bg-amber-500 border-amber-400 text-slate-950' : 'bg-slate-900 border-slate-800 text-slate-500'}`}
                                >
                                    {l}
                                </button>
                            ))}
                        </div>
                        <div className="flex-1 flex gap-2 w-full relative">
                            <input 
                                type="text" 
                                value={currentNote}
                                onChange={e => setCurrentNote(e.target.value)}
                                placeholder="觀察筆記..."
                                className="w-full bg-slate-950 border border-slate-800 rounded-2xl px-5 py-3 pr-12 text-slate-200 outline-none"
                            />
                            <button onClick={handlePolish} className="absolute right-20 top-1/2 -translate-y-1/2 text-amber-500 p-2">
                                <svg className={`w-5 h-5 ${isPolishing ? 'animate-spin' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                            </button>
                            <button onClick={() => { if(!currentNote) return; addLog('NOTE', '筆記', currentNote); setCurrentNote(''); }} className="bg-slate-900 px-6 py-3 rounded-2xl font-bold">發送</button>
                        </div>
                    </footer>

                    {/* Summary Modal */}
                    {showSummary && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/80 backdrop-blur-md">
                            <div className="bg-slate-900 border border-amber-500/20 w-full max-w-4xl max-h-[90vh] rounded-3xl overflow-hidden flex flex-col shadow-2xl animate-in zoom-in-95">
                                <div className="p-8 border-b border-slate-800 flex justify-between items-center">
                                    <h3 className="text-3xl font-bold klimt-gradient bg-clip-text text-transparent">觀課結案報告</h3>
                                    <button onClick={() => setShowSummary(false)} className="text-slate-500 hover:text-white text-2xl">✕</button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-8 custom-scrollbar">
                                    {aiReport ? (
                                        <div className="prose prose-invert prose-amber max-w-none" dangerouslySetInnerHTML={{ __html: window.marked.parse(aiReport) }} />
                                    ) : (
                                        <div className="text-center text-slate-500 py-20">
                                            <p className="mb-4">觀課已結束，時長：{formatTime(sessionTime)}</p>
                                            <button onClick={generateAIReport} className="bg-amber-500 text-slate-950 px-8 py-3 rounded-2xl font-bold shadow-lg">✨ 生成 AI 分析報告</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
